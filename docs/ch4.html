<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.282">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Rによるデータ解析のための前処理 - 4&nbsp; データ型に応じた処理</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<link href="./ch5.html" rel="next">
<link href="./ch3.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">データ型に応じた処理</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Rによるデータ解析のための前処理</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/uribo/dmr" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">まえがき</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">データを扱うための下準備</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">データ整形および操作: tidyr, dplyrパッケージの基礎</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">表形式のデータソースからのデータ取得</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch4.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">データ型に応じた処理</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch5.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">効率的なデータ操作</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch6.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">tidyverseの組み合わせ</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch7.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">オープンデータの整形</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#string" id="toc-string" class="nav-link active" data-scroll-target="#string"> <span class="header-section-number">4.1</span> 文字列処理</a>
  <ul class="collapse">
  <li><a href="#rにおける文字列の扱い" id="toc-rにおける文字列の扱い" class="nav-link" data-scroll-target="#rにおける文字列の扱い"> <span class="header-section-number">4.1.1</span> Rにおける文字列の扱い</a></li>
  <li><a href="#stringrパッケージを使った文字列操作" id="toc-stringrパッケージを使った文字列操作" class="nav-link" data-scroll-target="#stringrパッケージを使った文字列操作"> <span class="header-section-number">4.1.2</span> stringrパッケージを使った文字列操作</a></li>
  <li><a href="#forcats" id="toc-forcats" class="nav-link" data-scroll-target="#forcats"> <span class="header-section-number">4.1.3</span> forcatsパッケージ</a></li>
  </ul></li>
  <li><a href="#date-and-time" id="toc-date-and-time" class="nav-link" data-scroll-target="#date-and-time"> <span class="header-section-number">4.2</span> 日付・時間データの扱い</a>
  <ul class="collapse">
  <li><a href="#rにおける日付時間データ" id="toc-rにおける日付時間データ" class="nav-link" data-scroll-target="#rにおける日付時間データ"> <span class="header-section-number">4.2.1</span> Rにおける日付・時間データ</a></li>
  <li><a href="#lubridate" id="toc-lubridate" class="nav-link" data-scroll-target="#lubridate"> <span class="header-section-number">4.2.2</span> lubridateパッケージ</a></li>
  </ul></li>
  <li><a href="#まとめ" id="toc-まとめ" class="nav-link" data-scroll-target="#まとめ"> <span class="header-section-number">4.3</span> まとめ</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/uribo/dmr/edit/main/ch4.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">データ型に応じた処理</span></h1>
</div>





<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>これまでは<strong>tidyverse</strong>で利用可能な、データ操作に特化したパッケージの働きについて見てきたが、この章では前半に文字列、因子データの処理として<strong>stringr</strong>パッケージおよび<strong>forcats</strong>を導入する。また後半では日付・時間のデータを扱うための<strong>lubridate</strong>パッケージを紹介する。これらのパッケージはすべて<strong>tidyverse</strong>に含まれており、<code>library(tidyverse)</code>で利用可能になる。パッケージの関数は単一で利用しても便利であるが、パイプ演算子や<strong>dplyr</strong>、<strong>purrr</strong>といったパッケージと組み合わせることで、より利用範囲を広げられるだろう。</p>
<section id="string" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="string"><span class="header-section-number">4.1</span> 文字列処理</h2>
<p>データ分析において文字列は、性別や曜日などの決まった項目が用いられるものからユーザ名のように利用可能な文字や長さに制限があるもの、アンケートの回答結果など様々だ。文字列の操作には結合や分割、検索、置換などがある。まずはRにおける文字列データの基本を覚えよう。</p>
<section id="rにおける文字列の扱い" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="rにおける文字列の扱い"><span class="header-section-number">4.1.1</span> Rにおける文字列の扱い</h3>
<p>Rでは文字列を場合、引用符により文字列を囲む必要がある。引用符は一重引用符 (シングルクオート <code>'</code>)でも二重引用符 (ダブルクオート <code>"</code>)でも構わないが、文字列を囲む際はその種類を揃えておかなければならない。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 引用符によって囲んだ文字が文字データとして扱われる</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="st">"こんにちは"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "こんにちは"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(<span class="st">'引用符で囲む'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
</div>
<p>引用符を揃えない限り、Rコンソールは文字列の入力を受け付ける状態となる。始まりと終わりと引用符の種類が揃っていれば良いと先に述べたが、極力ドキュメントやプロジェクト中で引用符の種類は変更しないことが望ましい。</p>
<pre><code>"引用符の種類は統一しておく'
# +</code></pre>
<p>では文字列の中で引用符を利用するにはどうするか。これは文字に含ませる引用符と異なる引用符を囲み文字に採用するか、バックスラッシュ記号 (“\”) で引用符をエスケープすることで可能となる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cat()は与えられた文字列をコンソールに出力する標準出力のための関数</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"引用符 ' を使う"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>引用符 ' を使う</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">'引用符 " を使う'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>引用符 " を使う</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># バックスラッシュによるエスケープも可能</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">'引用符 </span><span class="sc">\'</span><span class="st"> を使う'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>引用符 ' を使う</code></pre>
</div>
</div>
<p>文章を区切るための改行は、Rでは<code>\n</code>で表現する。<code>\n</code>で一行分の改行となる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"こんにちは。</span><span class="sc">\n</span><span class="st">今日は天気が良いですね。"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>こんにちは。
今日は天気が良いですね。</code></pre>
</div>
</div>
</section>
<section id="stringrパッケージを使った文字列操作" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="stringrパッケージを使った文字列操作"><span class="header-section-number">4.1.2</span> stringrパッケージを使った文字列操作</h3>
<p><strong>tidyverse</strong>には<strong>stringr</strong>パッケージが文字列の処理に特化したパッケージとして用意される。本書でもこのパッケージを利用した例を紹介するが、<strong>stringr</strong>の関数が提供する正規表現の機能は、名称の類似した<strong>stringi</strong>が元となっている。興味のある読者は<strong>stringi</strong>の関数やドキュメントを参照すると良い。</p>
<p><strong>stringr</strong>パッケージの関数による文字列操作はRで標準利用可能な関数としても提供されているものが多いが、標準で利用できる関数はパイプ処理と組み合わせて利用することを想定していない。また<strong>stringr</strong>では<strong>stringi</strong>パッケージがサポートするIUC (International Components for Unicode)ライブラリの機能を利用できる。ICUライブラリはユニコードに関するさまざまな処理や操作に優れている。また、いくつかのRの標準関数が因子型のデータを入力値として利用できないのに対して、<strong>stringr</strong>は文字列型と同様に処理するという違いもある。</p>
<!-- stringr と stringiの関数の対応表 (付録?) -->
<p>ここからは<strong>stringr</strong>パッケージを使った文字列の操作方法について紹介していこう。また、一部で<strong>stringi</strong>パッケージの関数を参照することもあるが、<strong>stringr</strong>パッケージのインストールが済んでいれば追加でインストールする必要はない。<strong>stringr</strong>パッケージのほとんどの関数の多くは<code>str_*()</code>で実行される。<code>str_</code>の接頭辞のあとは関数が行う処理の内容を示している。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="結合" class="level4" data-number="4.1.2.1">
<h4 data-number="4.1.2.1" class="anchored" data-anchor-id="結合"><span class="header-section-number">4.1.2.1</span> 結合</h4>
<p><code>str_c()</code>は、引数に与えた複数の文字列を一つの文字列に結合する関数である。結合の際に文字列の間に任意の文字を指定可能であり、これは<em>sep</em>引数で指定する。既定値は”“(空白文字列)となっている。引数内で複数の要素をもつベクトルが与えられた時、結合はベクトルの各要素に対して行われる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 引数に与えられた文字を結合する</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_c</span>(<span class="st">"こんにちは"</span>, <span class="st">"今日の天気は"</span>, <span class="st">"晴れです"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "こんにちは今日の天気は晴れです"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sep引数で文字の区切りとなる位置に指定した文字を挿入する</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_c</span>(<span class="st">"こんにちは"</span>, <span class="st">"今日の天気は"</span>, <span class="st">"晴れです"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "こんにちは_今日の天気は_晴れです"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 長さが異なるベクトルが与えられた時、要素は再利用される</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 返り値は要素の数が最も多いベクトルに合わせて出力される</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_c</span>(<span class="st">"こんにちは今日の天気は"</span>, </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">"晴れ"</span>, <span class="st">"曇り"</span>, <span class="st">"雨"</span>), </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">"です"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "こんにちは今日の天気は晴れです" "こんにちは今日の天気は曇りです"
[3] "こんにちは今日の天気は雨です"  </code></pre>
</div>
</div>
<p><em>collapse</em>引数を利用することで、返り値が複数の要素になる出力においても、単一のベクトルとして結合が行われる。<em>collapse</em>に指定した文字は、入力に与えられた要素と要素をつなぐ文字列として利用される。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3つの長さのベクトルをcollapse引数で与えた文字列によって単一のベクトルに結合する</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_c</span>(<span class="st">"こんにちは今日の天気は"</span>, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">"晴れ"</span>, <span class="st">"曇り"</span>, <span class="st">"雨"</span>), </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">"です"</span>, </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">collapse =</span> <span class="st">"。"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "こんにちは今日の天気は晴れです。こんにちは今日の天気は曇りです。こんにちは今日の天気は雨です"</code></pre>
</div>
</div>
<p>同じく、<code>str_flatten()</code>も与えられた文字列の要素を結合して一つの文字列として返却する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_flatten</span>(<span class="fu">c</span>(<span class="st">"あ"</span>, <span class="st">"い"</span>, <span class="st">"う"</span>, <span class="st">"え"</span>, <span class="st">"お"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "あいうえお"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_flatten</span>(<span class="fu">c</span>(<span class="st">"あ"</span>, <span class="st">"い"</span>, <span class="st">"う"</span>, <span class="st">"え"</span>, <span class="st">"お"</span>), <span class="at">collapse =</span> <span class="st">"_"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "あ_い_う_え_お"</code></pre>
</div>
</div>
</section>
<section id="抽出" class="level4" data-number="4.1.2.2">
<h4 data-number="4.1.2.2" class="anchored" data-anchor-id="抽出"><span class="header-section-number">4.1.2.2</span> 抽出</h4>
<p>文字列から一部の文字を取り出すには<code>str_sub()</code>および<code>str_subset()</code>を使う。<code>str_sub()</code>は引数<em>start</em>と<em>end</em>それぞれで抽出したい文字の位置を指定する。この際、負値を与えることも可能であり、例えば<em>start</em>に-2を与えると、文字列の末尾から2文字分遡った位置が起点となる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_sub</span>(<span class="at">string =</span> <span class="st">"こんにちは"</span>, <span class="at">start =</span> <span class="dv">3</span>, <span class="at">end =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "にちは"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 負値により、対象が文字の末尾になる</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_sub</span>(<span class="at">string =</span> <span class="st">"こんにちは"</span>, <span class="at">start =</span> <span class="sc">-</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ちは"</code></pre>
</div>
</div>
<p>文字の位置ではなく、対象の文字列、パターンが含まれるものを取り出すには<code>str_subset()</code>を使う。また、値そのものではなく、該当箇所の位置に興味がある場合は<code>str_which()</code>を用いると良い。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 「ん」を含んだ文字列の要素を返却する</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_subset</span>(<span class="fu">c</span>(<span class="st">"おはよう"</span>, <span class="st">"こんにちは"</span>, <span class="st">"こんばんは"</span>), </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">pattern =</span> <span class="st">"ん"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "こんにちは" "こんばんは"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2, 3番目の要素に「ん」が含まれる</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_which</span>(<span class="fu">c</span>(<span class="st">"おはよう"</span>, <span class="st">"こんにちは"</span>, <span class="st">"こんばんは"</span>), </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">pattern =</span> <span class="st">"ん"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2 3</code></pre>
</div>
</div>
</section>
<section id="長さを調べる回数を数える" class="level4" data-number="4.1.2.3">
<h4 data-number="4.1.2.3" class="anchored" data-anchor-id="長さを調べる回数を数える"><span class="header-section-number">4.1.2.3</span> 長さを調べる、回数を数える</h4>
<p>「こんにちは」は長さが5の文字列であるが<strong>stringr</strong>では文字の長さを数えるのに<code>str_length()</code>を利用する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_length</span>(<span class="at">string =</span> <span class="st">"こんにちは"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_length</span>(<span class="fu">c</span>(<span class="st">"つくば"</span>, <span class="st">"Tsukuba"</span>, <span class="st">"筑波"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3 7 2</code></pre>
</div>
</div>
<p>入力に欠損が与えられた場合にはNAが返される。これはRに標準で利用可能な関数として用意される<code>nchar()</code>と同じ挙動であるが、<code>str_length()</code>は因子型のデータを与えた場合にも文字列のカウントを実行する(<code>nchar()</code>は因子型のデータの入力を受け付けない)。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_length</span>(<span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>animals <span class="ot">&lt;-</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"cat"</span>, <span class="st">"dog"</span>, <span class="st">"mouse"</span>, <span class="st">"boar"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">factor</span>()</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str_length</span>(animals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3 3 5 4</code></pre>
</div>
</div>
<p>文字列中に含まれる単語や一文の数を数える処理は<code>str_count()</code>でも実行できる。この関数は引数<em>pattern</em>で指定した文字列が含まれる回数を数えるもので、次の処理ではベクトルの各要素に含まれる「ん」の文字数を数えている。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_count</span>(<span class="fu">c</span>(<span class="st">"こんにちは"</span>, <span class="st">"こんばんは"</span>, <span class="st">"こん"</span>), </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">pattern =</span> <span class="st">"ん"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 1</code></pre>
</div>
</div>
</section>
<section id="パターンマッチ" class="level4" data-number="4.1.2.4">
<h4 data-number="4.1.2.4" class="anchored" data-anchor-id="パターンマッチ"><span class="header-section-number">4.1.2.4</span> パターンマッチ</h4>
<p>対象の文字列の中の一部、あるいは特定の要素に対してのみ処理を実行する、という時にはパターンマッチを利用した処理が有効である。例えばパターンマッチの方法には、先に<code>str_count()</code>の例で見たように特定の文字列を与えることもできるが、<strong>stringr</strong>ではより柔軟に文字列のマッチングを行える仕組みが備わっている。</p>
<p><strong>stringr</strong>パッケージで利用可能な関数の引数<em>pattern</em>は、次の方法によるパターンマッチが可能である(既定では<code>regex()</code>を用いて指定する正規表現が適用される)。これらの方法と関連する話題について詳細を見ていくために、まずは4つの文字を含んだ文字列ベクトルを用意しよう。続いて<code>str_detect()</code>を用いながら、引数<em>pattern</em>に与える処理を変えながら、それぞれの挙動を確認する。</p>
<p><code>fixed()</code>: 与えられた文字を直接評価するパターンマッチ</p>
<p><code>regex()</code>: 正規表現によるパターンマッチ。ICUの正規表現規則に従う</p>
<p><code>coll()</code>: ロケールを考慮したパターンマッチ</p>
<p><code>boundary()</code>: 文章の境界、すなわち文字 character、単語 word、改行 line_breake、段落 sentenceで指定するパターンマッチ</p>
<p><code>str_detect()</code>は指定したパターンが対象の文字列に含まれるかを判定する関数だ。返り値は論理値である。パターンと一致すれば<em>TRUE</em>となる。最初の例では、“^a”を<em>pattern</em>に指定した。2番目は<code>fixed()</code>の内部で同じ文字列を指定したが、結果は異なっている。<code>fixed()</code>は、<em>pattern</em>に与えられた文字列を直接パターンマッチに利用するためである。“^a”で使っている”^“は、後続のパターンが先頭文字を示す記号として評価されるもので、対象となる<strong>strings</strong>の中にはその文字は含まれない。</p>
<p><em>pattern</em>に指定可能な関数には、<code>boundary()</code>を除いて<em>ignore_case</em>引数が用意されている。これはアルファベットの大文字と小文字を区別しないためのオプションで、通常は<em>FALSE</em>が与えられる(大文字と小文字を厳密に区別する)。3番目の例では<code>regex()</code>を使っているいるが、<em>igreno_case</em>を<em>TRUE</em>とし、先頭が”a”となる大文字・小文字がある場合に<em>TRUE</em>を返すようになっている。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># \u0061 はaのユニコードエスケープ</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>strings <span class="ot">&lt;-</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"\u0061"</span>, <span class="st">"A"</span>, <span class="st">"あ"</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 既定値はregex()の指定と等しい</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(<span class="at">string =</span> strings, </span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">pattern =</span> <span class="st">"a"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE  TRUE FALSE FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fixed()を使用</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(<span class="at">string =</span> strings, </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">pattern =</span> <span class="fu">fixed</span>(<span class="at">pattern =</span> <span class="st">"^a"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE FALSE FALSE FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># regex()を明示して使用。先頭がaまたはAで始まる文字にマッチ</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(<span class="at">string =</span> strings, </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">pattern =</span> <span class="fu">regex</span>(<span class="at">pattern =</span> <span class="st">"^a"</span>, </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ignore_case =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE  TRUE  TRUE FALSE</code></pre>
</div>
</div>
<p>また<code>regex()</code>は他に<em>multiline</em>、<em>comments</em>、<em>dotall</em>引数を備えている。これらはいずれも論理値を指定する。既定では<em>FALSE</em>が与えられている。<em>multilne</em>が与えられた要素に改行(“\n”)があった時に、改行ごとにパターンマッチを評価するかを、<em>comments</em>は<em>TRUE</em>の時に、要素に含まれる、先頭文字の”#“記号および空白文字列を無視する、<em>dotall</em>は”.”を文字として評価しないことをそれぞれ意味している。これらのオプションは<code>regex()</code>は、“^”や”$“、”.”といった記号が次に述べるように、正規表現の記号と区別するために機能する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(<span class="st">"今日の天気は晴れです。</span><span class="sc">\n</span><span class="st">気温は26度を超えます。"</span>,</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>           <span class="fu">regex</span>(<span class="st">"です。$"</span>, <span class="at">multiline =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(<span class="st">"# 今日の天気は晴れです。"</span>,</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>           <span class="fu">regex</span>(<span class="st">"です。$"</span>, <span class="at">comments =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract</span>(<span class="st">"# 今日の天気は晴れです</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>           <span class="fu">regex</span>(<span class="st">"晴れです."</span>, <span class="at">dotall =</span> <span class="cn">FALSE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract</span>(<span class="st">"# 今日の天気は晴れです</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>           <span class="fu">regex</span>(<span class="st">"晴れです."</span>, <span class="at">dotall =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "晴れです\n"</code></pre>
</div>
</div>
<p>続いて、<code>coll()</code>を<em>pattern</em>に指定した場合は次のような結果を返す。<code>coll()</code>は、ロケール(3章参照)を考慮したパターンマッチを適用する関数で、例えば、大文字のIはユニコード表記では”\u49”となるがトルコ語などはIと区別してİを利用する。これはユニコード表記では”\u0130”である。どちらも文字としてはIを示すため、<em>locale</em>にトルコの言語ロケールである”tr”を指定するとマッチングする。また、ここで指定可能なロケール一覧は<code>stringi::stri_locale_list()</code>によって確認できる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"I"</span>, <span class="st">"\u0130"</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract</span>(<span class="at">string =</span> i, </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">pattern =</span> <span class="fu">coll</span>(<span class="at">pattern =</span> <span class="st">"I"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "I" NA </code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract</span>(<span class="at">string =</span> i, </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">pattern =</span> <span class="fu">coll</span>(<span class="at">pattern =</span> <span class="st">"i"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>, <span class="at">locale =</span> <span class="st">"tr"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA  "İ"</code></pre>
</div>
</div>
<p>最後に<code>boundary()</code>の例であるが、これは文字の分割を行う<code>str_split()</code>の節で紹介する。</p>
<section id="正規表現" class="level5" data-number="4.1.2.4.1">
<h5 data-number="4.1.2.4.1" class="anchored" data-anchor-id="正規表現"><span class="header-section-number">4.1.2.4.1</span> 正規表現</h5>
<p>正規表現は文字列のパターンを表現する方法の一つである。文字列の中から特定の文字を検出したり、検出した文字を置換する、といった処理が正規表現を通して実行できる。正規表現は、Rの標準機能にも備わっているが、<strong>stringr</strong>パッケージが実装するICUのライブラリはより自由度の高い文字列パターンを扱うことができる。実際にこの章で紹介してきた関数で引数<em>pattern</em>があるものでは、同様の指定と処理が可能である。正規表現の詳細については奥が深く、すべてを理解することは困難であるが、ここで述べるような基本的な利用方法や、ある程度の内容について理解しておくだけで充分な価値がある。</p>
<p>3つの要素を文字ベクトルから引数<em>pattern</em>に指定した文字「ほくそ」が含まれているかを判定する処理は以下のようになる。</p>
<!-- \footnote{詳細は?stringi::`stringi-search-regex`で表示されるドキュメントを参照}。 -->
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>hoxom <span class="ot">&lt;-</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"ほくそえむ"</span>, <span class="st">"ほくそうむ"</span>, <span class="st">"ほくそうり"</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(hoxom, <span class="st">"ほくそ"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE TRUE TRUE</code></pre>
</div>
</div>
<p>ベクトル<em>hoxom</em>に格納したすべての文字列は「ほくそ」を含んでいるため、この結果はすべて真となる。では次の例はどうだろうか。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(<span class="at">string =</span> hoxom, <span class="at">pattern =</span> <span class="st">"む$"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE  TRUE FALSE</code></pre>
</div>
</div>
<p>今度は3つ目の「ほくそうり」で<em>FALSE</em>を返すようになった。上記のコードで与えたパターンは「む」で終わる、である。記号<code>$</code>は文字列の終わりを示している。この他にも正規表現で利用可能な記号はいくつかの種類があり、<strong>メタ文字</strong>と呼ばれる正規表現の中で利用できる修飾子である。メタ文字を利用したパターンマッチの処理の例をいくつか見てみよう。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># xの要素はすべて「ほくそ」で始まるため、任意の一文字を示す . を使うとマッチしなくなる</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(<span class="at">string =</span> hoxom, <span class="at">pattern =</span> <span class="st">".ほくそ"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE FALSE FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 先頭および末尾の文字列を、^と$で指定したパターン</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 「ほくそ」と「む」の中には別の文字列が含まれていても良いとする</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(<span class="at">string =</span> hoxom, <span class="at">pattern =</span> <span class="st">"^ほくそ.+む$"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE  TRUE FALSE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>fruits <span class="ot">&lt;-</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"バナナ"</span>, <span class="st">"リンゴ"</span>, <span class="st">"パイナップル"</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 「ナ」が含まれる文字列にTRUEを返す</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(fruits, <span class="st">"ナ"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE FALSE  TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># {2}は「ナ」の2回繰り返しを示す</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co"># バナナはナが連続して出現するが、パイナップルはナが1回しか出現しない</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(fruits, <span class="st">"ナ{2}"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE FALSE FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3回以上4回未満の「ナ」の出現はいずれの要素にも含まれない</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(fruits, <span class="st">"ナ{3,4}"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE FALSE FALSE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>prefs <span class="ot">&lt;-</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"神奈川県"</span>, <span class="st">"東京都"</span>, <span class="st">"沖縄県"</span>, <span class="st">"岡山県"</span>, <span class="st">"富山県"</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 「県」で終わり、山または川を含んだ文字列にマッチ</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(prefs, <span class="st">"(山|川)県$"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE FALSE FALSE  TRUE  TRUE</code></pre>
</div>
</div>
<!-- 表: Rがサポートする修飾子(メタ文字) -->
<table class="table">
<thead>
<tr class="header">
<th>修飾子</th>
<th style="text-align: left;">意味</th>
<th style="text-align: left;">指定の種類</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>^</td>
<td style="text-align: left;">以後の文字が先頭にある</td>
<td style="text-align: left;">位置</td>
</tr>
<tr class="even">
<td>$</td>
<td style="text-align: left;">以前の文字が後尾にある</td>
<td style="text-align: left;">位置</td>
</tr>
<tr class="odd">
<td>.</td>
<td style="text-align: left;">任意の一文字</td>
<td style="text-align: left;">対象</td>
</tr>
<tr class="even">
<td>|</td>
<td style="text-align: left;">複数のパターンに区切る</td>
<td style="text-align: left;">対象</td>
</tr>
<tr class="odd">
<td>(), [], {}</td>
<td style="text-align: left;">パターンをグループ化する</td>
<td style="text-align: left;">対象</td>
</tr>
<tr class="even">
<td>*</td>
<td style="text-align: left;">直前パターンをn回繰り返し(n &gt;= 0)</td>
<td style="text-align: left;">繰り返し</td>
</tr>
<tr class="odd">
<td>?</td>
<td style="text-align: left;">直前パターンをn回繰り返し(n = 0, 1)</td>
<td style="text-align: left;">繰り返し</td>
</tr>
<tr class="even">
<td>+</td>
<td style="text-align: left;">直前パターンをn回以上の繰り返し</td>
<td style="text-align: left;">繰り返し</td>
</tr>
<tr class="odd">
<td>{n}</td>
<td style="text-align: left;">直前パターンをn回繰り返し</td>
<td style="text-align: left;">繰り返し</td>
</tr>
<tr class="even">
<td>{n, }</td>
<td style="text-align: left;">直前パターンをn回以上の繰り返し</td>
<td style="text-align: left;">繰り返し</td>
</tr>
<tr class="odd">
<td>{n, m}</td>
<td style="text-align: left;">直前のパターンをn回以上m回以下繰り返し</td>
<td style="text-align: left;">繰り返し</td>
</tr>
</tbody>
</table>
<p>指定したパターンが文字列中のどの位置でマッチしているかを確認する方法として、<strong>stringr</strong>では<code>str_view()</code>あるいは<code>str_view_all()</code>が用意されている。この関数は<code>str_detect()</code>などの関数同様、対象の文字列とパターンマッチに用いる文字列を指定するが、実行するとウェブブラウザまたはRStudioを利用している場合はViewerパネル中に、マッチする箇所を表示する画面が出現する。グレーでハイライトされている箇所が引数<em>pattern</em>で指定した文字列とマッチする箇所を示している。引数<em>match</em>は<em>string</em>に与えられた文字列中にマッチする要素だけ、あるいはマッチしない要素だけを表示するかを選択するオプションでり、論理値で指定する。既定では<em>NA</em>が与えられ、いずれの要素も表示する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_view</span>(<span class="at">string =</span> hoxom, <span class="at">pattern =</span> <span class="st">"ほくそ"</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_view</span>(<span class="at">string =</span> <span class="fu">c</span>(<span class="st">"ほくそ"</span>, <span class="st">"もなぎ"</span>), </span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">pattern =</span> <span class="st">"ほくそ"</span>, <span class="at">match =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/fig-ch5-str-view.png" class="img-fluid figure-img"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">str_view()によるマッチ箇所の確認</figcaption><p></p>
</figure>
</div>
</section>
<section id="文字クラスposix文字クラス" class="level5" data-number="4.1.2.4.2">
<h5 data-number="4.1.2.4.2" class="anchored" data-anchor-id="文字クラスposix文字クラス"><span class="header-section-number">4.1.2.4.2</span> 文字クラス・POSIX文字クラス</h5>
<p>対象の文字が特定の文字列の組み合わせで生成されている場合には、文字クラスあるいはPOSIX文字クラスを利用したパターンマッチが可能になる。文字クラスでは、ブラケット (<code>[]</code>)で挟んだ範囲の文字をパターンとみなし、更に連続する文字列の場合、例えばAからZまでのアルファベッドを指定する際にABC..Zとするのではなく、<code>A-Z</code>と対象の文字列の範囲を<code>-</code>で文字をつなぐことで複数の文字をパターンに含めることができる。</p>
<!-- 表: Rがサポートする文字クラス -->
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">文字クラス</th>
<th style="text-align: left;">対象</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">[0-9]</td>
<td style="text-align: left;">アラビア数字</td>
</tr>
<tr class="even">
<td style="text-align: left;">[a-z]</td>
<td style="text-align: left;">小文字アルファベット</td>
</tr>
<tr class="odd">
<td style="text-align: left;">[A-Z]</td>
<td style="text-align: left;">大文字アルファベット</td>
</tr>
<tr class="even">
<td style="text-align: left;">[ぁ-ん]</td>
<td style="text-align: left;">ひらがな</td>
</tr>
<tr class="odd">
<td style="text-align: left;">[ァ-ヶ]</td>
<td style="text-align: left;">カタカナ</td>
</tr>
<tr class="even">
<td style="text-align: left;">[一-龠]</td>
<td style="text-align: left;">漢字 (すべての漢字に対応できるわけではない)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">[\x01-\x7E]</td>
<td style="text-align: left;">1バイト文字</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>strings <span class="ot">&lt;-</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"ひらがな"</span>, <span class="st">"カタカナ"</span>, <span class="st">"漢字"</span>, <span class="st">"ABC"</span>, <span class="st">"abc"</span>, <span class="st">"123"</span>, <span class="st">"a2c4e6"</span>)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 大文字のA, B, Cのいずれかを含んだパターン</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(strings, <span class="st">"[A-C]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE FALSE FALSE  TRUE FALSE FALSE FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ひらがなにマッチするパターン</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(strings, <span class="st">"[ぁ-ん]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 複数の文字クラスやメタ文字を扱うこともできる</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co"># アルファベットのAからZまで(大文字、小文字)を含んだパターンの検出</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 「ABC」, 「abc」, 「a2c4e6」にマッチする</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(strings, <span class="st">"[A-Za-z]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE FALSE FALSE  TRUE  TRUE FALSE  TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(strings, <span class="fu">regex</span>(<span class="st">"[A-Z]"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE FALSE FALSE  TRUE  TRUE FALSE  TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 先頭および末尾が数値で、長さが3の文字とマッチするパターン</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 「123」に該当</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(strings, <span class="st">"^[0-9]{3}$"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE FALSE FALSE FALSE FALSE  TRUE FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ひらがな、カタカナ、漢字の一部を含んだパターンを検出</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 「ひらがな」, 「カタカナ」, 「漢字」にマッチ</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_detect</span>(strings, <span class="st">"[ぁ-んァ-ヶ一-龠]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE</code></pre>
</div>
</div>
<p>POSIX文字クラスは一致するパターンを特定の種類にまとめ、特殊な表記を行うことで複数の文字を一度に対象パターンとして取り扱う。POSIX文字クラスは文字クラス同様、ブラケットを利用した記述を利用するが、加えてコロン (<code>:</code>)によってPOSIX文字クラス名を囲むという特徴がある。Rで利用可能なPOSIX文字クラスについて表XXに示した。</p>
<!-- 表: RがサポートするPOSIX文字クラス -->
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">POSIX文字クラス</th>
<th style="text-align: left;">対象</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">[:alnum:]</td>
<td style="text-align: left;">アルファベットと数値([:alpha:] + [:digit:])</td>
</tr>
<tr class="even">
<td style="text-align: left;">[:alpha:]</td>
<td style="text-align: left;">大小文字アルファベット([:upper:] + [:lower:])</td>
</tr>
<tr class="odd">
<td style="text-align: left;">[:upper:]</td>
<td style="text-align: left;">大文字アルファベット</td>
</tr>
<tr class="even">
<td style="text-align: left;">[:lower:]</td>
<td style="text-align: left;">小文字アルファベット</td>
</tr>
<tr class="odd">
<td style="text-align: left;">[:digit:]</td>
<td style="text-align: left;">数値</td>
</tr>
<tr class="even">
<td style="text-align: left;">[:blank:]</td>
<td style="text-align: left;">空白文字、スペースとタブ</td>
</tr>
<tr class="odd">
<td style="text-align: left;">[:cntrl:]</td>
<td style="text-align: left;">制御文字</td>
</tr>
<tr class="even">
<td style="text-align: left;">[:graph:]</td>
<td style="text-align: left;">空白以外の文字 ([:alnum:] + [:punct:])</td>
</tr>
<tr class="odd">
<td style="text-align: left;">[:print:]</td>
<td style="text-align: left;">印字可能な文字([:graph:] + スペース)</td>
</tr>
<tr class="even">
<td style="text-align: left;">[:punct:]</td>
<td style="text-align: left;">補助符号を含めた句読点(! ” # $ % &amp; ’ ( ) * + , - . /)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">[:space:]</td>
<td style="text-align: left;">すべての空白文字</td>
</tr>
<tr class="even">
<td style="text-align: left;">[:xdigit:]</td>
<td style="text-align: left;">16進数で認められている文字(0-9a-fA-F)</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>strings <span class="ot">&lt;-</span> </span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"alphabet"</span>, <span class="st">"123456"</span>, <span class="st">"alnum789"</span>, <span class="st">"123 456"</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract</span>(<span class="at">string =</span> strings, <span class="at">pattern =</span> <span class="st">"[[:alpha:]]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a" NA  "a" NA </code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract</span>(strings, <span class="st">"[[:digit:]]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA  "1" "7" "1"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract</span>(strings, <span class="st">"[[:space:]]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA  NA  NA  " "</code></pre>
</div>
</div>
<p>ここで用いた<code>str_extract()</code>は、パターンにマッチした箇所を文字列で返却する。もし対象の文字列に含まれるパターンが指定されない場合、欠損が与えられる。<code>str_extract()</code>ではメタ文字による繰り返しを指定しない場合は最初に該当した箇所の文字を返すが、これに対して、対象の文字列中ですべての該当箇所を返すようにするには<code>str_extract_all()</code>を利用すると良い。この関数の返り値はリストであるが、引数<em>simplify</em>を<em>TRUE</em>とすることで各要素でマッチした箇所を含んだ行列になる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 対象文字列でマッチするすべての文字列をリストで返す</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract_all</span>(<span class="at">string =</span> strings, <span class="at">pattern =</span> <span class="st">"[[:alpha:]]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "a" "l" "p" "h" "a" "b" "e" "t"

[[2]]
character(0)

[[3]]
[1] "a" "l" "n" "u" "m"

[[4]]
character(0)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 各要素を行とし、マッチした箇所を含んだ行列として返却</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_extract_all</span>(strings, <span class="st">"[[:alpha:]]"</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]
[1,] "a"  "l"  "p"  "h"  "a"  "b"  "e"  "t" 
[2,] ""   ""   ""   ""   ""   ""   ""   ""  
[3,] "a"  "l"  "n"  "u"  "m"  ""   ""   ""  
[4,] ""   ""   ""   ""   ""   ""   ""   ""  </code></pre>
</div>
</div>
<p>複数の要素を与えた際、どの要素に対してマッチが行われているかを判断するために、<code>str_which()</code>を使う方法もある。</p>
</section>
<section id="文字ロケールの利用" class="level5" data-number="4.1.2.4.3">
<h5 data-number="4.1.2.4.3" class="anchored" data-anchor-id="文字ロケールの利用"><span class="header-section-number">4.1.2.4.3</span> 文字ロケールの利用</h5>
<p>[WIP]</p>
<!-- stringi::stri_locale_info() -->
</section>
</section>
<section id="文字列の削除と置換" class="level4" data-number="4.1.2.5">
<h4 data-number="4.1.2.5" class="anchored" data-anchor-id="文字列の削除と置換"><span class="header-section-number">4.1.2.5</span> 文字列の削除と置換</h4>
<p>文字列の中には、思わぬ空白文字列や改行が含まれ、処理の邪魔となることがある。<code>str_trim()</code>や<code>str_squish()</code>はこれらの余分な空白文字列や余分な改行を取り除く処理を実行する。次の文字列から、余分な改行や空白を取り除いてみよう。この文字列には、前後および途中で改行が与えられており、「でも」の後に空白文字列が与えられている。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 前後および文章の中に空白を含んだ文字列ベクトルを用意する</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>(x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"</span><span class="sc">\n</span><span class="st"> こんにちは。今日は天気が良いですね。</span><span class="sc">\n</span><span class="st">でも    明日は雨が降るらしいです </span><span class="sc">\n\n\n</span><span class="st">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "\n こんにちは。今日は天気が良いですね。\nでも    明日は雨が降るらしいです \n\n\n"</code></pre>
</div>
</div>
<p><code>str_trim()</code>は引数<em>side</em>の指定により、除去を行う方向を指定する。既定値では文字列の両側を対象にする(“both”)が、他に左右の指定(“left”および”right”)が可能である。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 文字列に含まれる空白文字の除去。既定値で両側の空白が対象になる</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_trim</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "こんにちは。今日は天気が良いですね。\nでも    明日は雨が降るらしいです"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_trim</span>(x, <span class="at">side =</span> <span class="st">"left"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "こんにちは。今日は天気が良いですね。\nでも    明日は雨が降るらしいです \n\n\n"</code></pre>
</div>
</div>
<p>さて、<code>str_trim()</code>によりいくつかの文字が取り除かれたが、依然として文章中に必要以上の空白が残っている。これは<code>str_squish()</code>で、単一の空白文字列へと置換可能できる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_squish</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "こんにちは。今日は天気が良いですね。 でも 明日は雨が降るらしいです"</code></pre>
</div>
</div>
<!-- ユニコード正規化の話は別の場所に移動。ただしコラムとして独立させるには勿体無い -->
<p>特定の文字列や文字列の一部を任意の値に変更する処理を実行するために<code>str_replace()</code>が利用できる。この関数には引数<em>pattern</em>と<em>replace</em>があり、対象のパターン、置換後の文字を指定する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_replace</span>(<span class="st">"こんばんは"</span>,</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">pattern     =</span> <span class="st">"ばんは"</span>, </span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">replacement =</span> <span class="st">"にちは"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "こんにちは"</code></pre>
</div>
</div>
<p><code>str_replace()</code>では、パターンに一致した箇所の置換を、最初に一致した箇所のみ対象にするが、すべての一致する箇所で置換を適用するには<code>str_replace_all()</code>を使う。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 「こんばんは」中の「ん」を空白文字列に置換</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="co"># str_replace()では、最初の「ん」しか変更されない</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_replace</span>(<span class="st">"こんばんは"</span>, <span class="st">"ん"</span>, <span class="st">" "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "こ ばんは"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># str_replace_all()を用いることですべての箇所が置換の対象になる</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_replace_all</span>(<span class="st">"こんばんは"</span>, <span class="st">"ん"</span>, <span class="st">" "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "こ ば は"</code></pre>
</div>
</div>
<p>また<code>str_replace_all()</code>では、複数の置換パターンを与えることも可能だ。これは引数<em>pattern</em>に<code>c(対象文字列 = 置換後の文字列)</code>の形で指定する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 複数のパターンの置換を同時に実行する</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> </span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"こんばんは"</span>, <span class="st">"こんにちは 今日は寒いですね"</span>)</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str_replace_all</span>(x, </span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">c</span>(<span class="st">"こんばんは"</span> <span class="ot">=</span> <span class="st">"今晩は"</span>, <span class="st">"寒い"</span> <span class="ot">=</span> <span class="st">"暑い"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "今晩は"                      "こんにちは 今日は暑いですね"</code></pre>
</div>
</div>
<p>次の例は、<em>pattern</em>引数に指定した住所文字列にマッチするパターンとして「東京都」「道」「府」「県」の4種を指定している。複数のパターンに対してマッチングを行うにはこのようにして<code>|</code>記号を用いて文字列を区切る。また京都府の場合には、2文字目の「京”都”府」にマッチしてしまうので、「都」を含んだ文字列でマッチングさせるのは「東京都」となるようにした。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>address <span class="ot">&lt;-</span> </span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"東京都渋谷区桜ヶ丘"</span>, </span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"岡山県岡山市北区清心町"</span>, </span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"茨城県つくば市小野川"</span>,</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"京都府舞鶴市字浜"</span>)</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="fu">str_replace</span>(<span class="at">string =</span> address, </span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">pattern =</span> <span class="st">"(東京都|道|府|県).+"</span>,</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">replacement =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "東京都" "岡山県" "茨城県" "京都府"</code></pre>
</div>
</div>
<p>正規表現では、パターンに含める文字列を括弧で囲むことで、マッチさせた文字列を利用できるようになる。これは<strong>後方参照</strong>と呼ばれる。マッチした文字列は、置換後の値を指定する引数<em>replacement</em>で<code>\\1</code>として呼び出している(<code>\</code>を繰り返すのはエスケープのため)。</p>
<p>マッチした箇所の文字列だけを除外するには、<code>str_remove()</code>を使う方法がある。これは<code>str_replace(string, pattern, replacement = "")</code>と同じ働きをもつ。この関数も対象文字列中でマッチする全箇所を対象にする<code>str_replace_all()</code>がある。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_remove</span>(<span class="st">"文字列の「この部分」を削除する"</span>, <span class="st">"この部分"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "文字列の「」を削除する"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 最初にマッチした箇所を除外する</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_remove</span>(<span class="st">"Hello world"</span>, <span class="st">"o"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Hell world"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 全てのマッチ箇所を除外の対象にする</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_remove_all</span>(<span class="st">"Hello world"</span>, <span class="st">"o"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Hell wrld"</code></pre>
</div>
</div>
<p>このほか、文字列置換の特殊な用途として、欠損 <em>NA</em>を文字列に変換する<code>str_replace_na()</code>が用意されている。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_replace_na</span>(<span class="fu">c</span>(<span class="cn">NA_character_</span>, <span class="st">"abc"</span>, <span class="st">"こんにちは"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "NA"         "abc"        "こんにちは"</code></pre>
</div>
</div>
</section>
<section id="分割" class="level4" data-number="4.1.2.6">
<h4 data-number="4.1.2.6" class="anchored" data-anchor-id="分割"><span class="header-section-number">4.1.2.6</span> 分割</h4>
<p><code>str_split()</code>および<code>str_split_fixed()</code>は、指定したパターンにマッチした箇所を起点に、対象の文字列を分割する関数である。ここで、分割に指定したパターンは、<code>boundary()</code>による文字の境界以外は返り値に含まれないという特徴がある。通常、対象の文字列でマッチする箇所があるたびに分割が行われるが、これは引数<em>n</em>に分割する数値を指定して制御できる(既定では<em>Inf</em>が指定される)。またこのオプションは<code>str_split()</code>ではリストの要素数の指定となるが、<code>str_split_fixed()</code>では行列の列数となり、ユーザの指定が必要なものとなる。なお<code>str_split()</code>の返り値はリストであるが、<em>simplify</em>引数で<em>TRUE</em>を指定すると<code>str_split_fixed()</code>と同じく行列が返されるようになる。後続の処理の用途に応じて使い分けると良いだろう。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>souseki_text <span class="ot">&lt;-</span> </span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"吾輩は猫である。名前はまだない。</span><span class="sc">\n</span><span class="st">どこで生れたかとんと見当けんとうがつかぬ。何でも薄暗いじめじめした所でニャーニャー泣いていた事だけは記憶している。"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 「である。」および「つかぬ。」が出現する位置で要素を分割する</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_split</span>(<span class="at">string =</span> souseki_text, <span class="at">pattern =</span> <span class="st">"(である|つかぬ)。"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "吾輩は猫"                                                                
[2] "名前はまだない。\nどこで生れたかとんと見当けんとうが"                    
[3] "何でも薄暗いじめじめした所でニャーニャー泣いていた事だけは記憶している。"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 引数nで返り値の要素数を制御</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="co"># n以上の分割は行われない</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_split</span>(souseki_text, </span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>          <span class="st">"(である|つかぬ)。"</span>, </span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">n =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "吾輩は猫"                                                                                                                            
[2] "名前はまだない。\nどこで生れたかとんと見当けんとうがつかぬ。何でも薄暗いじめじめした所でニャーニャー泣いていた事だけは記憶している。"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># str_split_fixed()の返り値は行列で、引数nにより列数を指定する</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_split_fixed</span>(<span class="at">string =</span> souseki_text, </span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">pattern =</span> <span class="st">"(である|つかぬ)。"</span>, </span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">n =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]      
[1,] "吾輩は猫"
     [,2]                                                                                                                                  
[1,] "名前はまだない。\nどこで生れたかとんと見当けんとうがつかぬ。何でも薄暗いじめじめした所でニャーニャー泣いていた事だけは記憶している。"</code></pre>
</div>
</div>
<p><em>pattern</em>の指定に<code>boundary()</code>を利用する場合、入力に用いた文字は残り、分割だけが行われる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_split</span>(souseki_text, <span class="fu">boundary</span>(<span class="st">"character"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
 [1] "吾" "輩" "は" "猫" "で" "あ" "る" "。" "名" "前" "は" "ま" "だ" "な" "い"
[16] "。" "\n" "ど" "こ" "で" "生" "れ" "た" "か" "と" "ん" "と" "見" "当" "け"
[31] "ん" "と" "う" "が" "つ" "か" "ぬ" "。" "何" "で" "も" "薄" "暗" "い" "じ"
[46] "め" "じ" "め" "し" "た" "所" "で" "ニ" "ャ" "ー" "ニ" "ャ" "ー" "泣" "い"
[61] "て" "い" "た" "事" "だ" "け" "は" "記" "憶" "し" "て" "い" "る" "。"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># マルチバイト文字を含んだ改行はうまくいかないことがある</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_split</span>(souseki_text, <span class="fu">boundary</span>(<span class="st">"line_break"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
 [1] "吾"     "輩"     "は"     "猫"     "で"     "あ"     "る。"   "名"    
 [9] "前"     "は"     "ま"     "だ"     "な"     "い。\n" "ど"     "こ"    
[17] "で"     "生"     "れ"     "た"     "か"     "と"     "ん"     "と"    
[25] "見"     "当"     "け"     "ん"     "と"     "う"     "が"     "つ"    
[33] "か"     "ぬ。"   "何"     "で"     "も"     "薄"     "暗"     "い"    
[41] "じ"     "め"     "じ"     "め"     "し"     "た"     "所"     "で"    
[49] "ニャー" "ニャー" "泣"     "い"     "て"     "い"     "た"     "事"    
[57] "だ"     "け"     "は"     "記"     "憶"     "し"     "て"     "い"    
[65] "る。"  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_split</span>(<span class="st">"blah</span><span class="sc">\n</span><span class="st">blah</span><span class="sc">\n</span><span class="st">blah"</span>, <span class="fu">boundary</span>(<span class="st">"line_break"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "blah\n" "blah\n" "blah"  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_split</span>(souseki_text, <span class="fu">boundary</span>(<span class="st">"word"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
 [1] "吾輩"         "は"           "猫"           "で"           "ある"        
 [6] "名前"         "は"           "まだ"         "ない"         "どこ"        
[11] "で"           "生れ"         "たか"         "とんと"       "見当"        
[16] "け"           "ん"           "と"           "うがつ"       "か"          
[21] "ぬ"           "何でも"       "薄暗い"       "じめじめ"     "した"        
[26] "所"           "で"           "ニャーニャー" "泣"           "い"          
[31] "て"           "いた事"       "だけ"         "は"           "記憶"        
[36] "し"           "て"           "いる"        </code></pre>
</div>
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_split</span>(souseki_text, <span class="fu">boundary</span>(<span class="st">"sentence"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "吾輩は猫である。"                                                        
[2] "名前はまだない。\n"                                                      
[3] "どこで生れたかとんと見当けんとうがつかぬ。"                              
[4] "何でも薄暗いじめじめした所でニャーニャー泣いていた事だけは記憶している。"</code></pre>
</div>
</div>
</section>
<section id="要素の並び替え" class="level4" data-number="4.1.2.7">
<h4 data-number="4.1.2.7" class="anchored" data-anchor-id="要素の並び替え"><span class="header-section-number">4.1.2.7</span> 要素の並び替え</h4>
<p>文字列要素の順番や並び替えに関する関数は2つ存在する。<code>str_order()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_order</span>(<span class="fu">c</span>(<span class="st">"あ"</span>, <span class="st">"え"</span>, <span class="st">"い"</span>, <span class="st">"う"</span>, <span class="st">"え"</span>, <span class="st">"お"</span>, <span class="st">"あ"</span>, <span class="st">"お"</span>),</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">locale =</span> <span class="st">"ja_JP"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 7 3 4 2 5 6 8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_sort</span>(<span class="fu">c</span>(<span class="st">"あ"</span>, <span class="st">"え"</span>, <span class="st">"い"</span>, <span class="st">"う"</span>, <span class="st">"え"</span>, <span class="st">"お"</span>, <span class="st">"あ"</span>, <span class="st">"お"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "あ" "あ" "い" "う" "え" "え" "お" "お"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>stringi<span class="sc">::</span><span class="fu">stri_order</span>(<span class="fu">c</span>(<span class="st">"い"</span>, <span class="st">"あ"</span>, <span class="st">"う"</span>, <span class="st">"あ"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2 4 1 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_order</span>(<span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 3 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_sort</span>(letters)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q" "r" "s"
[20] "t" "u" "v" "w" "x" "y" "z"</code></pre>
</div>
</div>
</section>
<section id="エンコード変換" class="level4" data-number="4.1.2.8">
<h4 data-number="4.1.2.8" class="anchored" data-anchor-id="エンコード変換"><span class="header-section-number">4.1.2.8</span> エンコード変換</h4>
<p>日本語などを含んだ文字列が正常に表示できていない状態、文字化けを起こしている場合、<code>str_conv()</code>を使い、エンコードし直すことで問題に対応することができる。新たに指定するエンコードは引数<em>encoding</em>で、エンコード名を文字列で与えるが、その一覧は<code>stringi::stri_enc_list()</code>で確認できる。この中で日本語に関するエンコードとしては”EUC-JP”、“ISO-2022-JP”、“cp932”、“UTF-8”などがある。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="st">"</span><span class="sc">\x82\xa0\x82\xa2\x82\xa4\x82\xa6\x82\xa8</span><span class="st">"</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="co"># str_conv()では元のエンコードを指定するだけで自動的に現在のエンコード形式に変更する</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_conv</span>(x, <span class="at">encoding =</span> <span class="st">"cp932"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "あいうえお"</code></pre>
</div>
</div>
</section>
<section id="文字列フォーマット" class="level4" data-number="4.1.2.9">
<h4 data-number="4.1.2.9" class="anchored" data-anchor-id="文字列フォーマット"><span class="header-section-number">4.1.2.9</span> 文字列フォーマット</h4>
<p>指定した書式（フォーマット）に基づき、与えられた値を文字列に変換する文字列フォーマットは、<code>str_interp()</code>ならびに<code>str_glue()</code>により提供される。これらの関数は、Rオブジェクトの値を利用することも可能である。やや指定方法に癖があるが、慣れれば、柔軟に文字列の生成が行えるので大変便利な関数である。</p>
<p><code>str_interp()</code>、<code>str_glue()</code>にはいくつかの利用方法がある。まず、Rオブジェクトの値を文字列中に利用するには、次のようにドル記号(“$”)に次いでブラケット(“{}”)で囲んだ中にRオブジェクトの変数名を与える。フォーマットを指定する場合、ドル記号の後、“{”ブラケットの前に”[“ブラケットの囲み文字でフォーマット指定を行う。指定可能なフォーマットはRで標準利用できる<code>sprintf()</code>と同じく、代表的なものを表XXに整理している。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>my_name <span class="ot">&lt;-</span> <span class="st">"真也"</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>age_year <span class="ot">&lt;-</span> <span class="dv">1989</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>age_jp_year <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 3つのオブジェクトを文字列の中で利用する。</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a><span class="co"># age_jp_year, age_yearの2箇所でフォーマットを指定している(ともに整数)</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str_interp</span>(<span class="st">"私の名前は${my_name}です。</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a><span class="st">平成$[02d]{age_jp_year}($[4d]{age_year})年の生まれです。"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "私の名前は真也です。\n平成01(1989)年の生まれです。"</code></pre>
</div>
</div>
<p>関数内で参照するRオブジェクトの評価は、文字列の出力時に行われるため、次のように修正を加えることもできる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_interp</span>(<span class="st">"$[4d]{age_year - 4}年の生まれです。"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1985年の生まれです。"</code></pre>
</div>
</div>
<p>関数内部でオブジェクトを生成し、それを利用することも可能である。これには<code>list()</code>を使い、変数名と値の組み合わせを指定する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_interp</span>(<span class="st">"$[4d]{age_year}年の生まれです。"</span>, </span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">env =</span> <span class="fu">list</span>(<span class="at">age_year =</span> <span class="dv">2000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2000年の生まれです。"</code></pre>
</div>
</div>
<p><code>str_glue()</code>は<strong>glue</strong>パッケージが提供する機能を実装したもので、<code>glue::glue()</code>、<code>glue::glue_data()</code>と同じ引数オプションが利用できる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_glue</span>(</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"{when}の時刻は {datetime}</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"時刻を書式化すると{format(datetime, '%Y年%m月%d日 %X')}</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"日付は {format(datetime, '%Y年%m月%d日')}　です</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"時刻は {format(datetime, '%X')} です"</span>,</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">when =</span> <span class="st">"ただいま"</span>,</span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">datetime =</span> <span class="fu">Sys.time</span>()</span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ただいまの時刻は 2022-05-02 16:57:10
時刻を書式化すると2022年05月02日 16:57:10
日付は 2022年05月02日　です
時刻は 16:57:10 です</code></pre>
</div>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>df_jyunishi <span class="ot">&lt;-</span> </span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">eto =</span> <span class="fu">c</span>(<span class="st">"子"</span>, <span class="st">"丑"</span>, <span class="st">"寅"</span>, <span class="st">"卯"</span>, <span class="st">"辰"</span>, <span class="st">"巳"</span>, <span class="st">"午"</span>,</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">"未"</span>, <span class="st">"申"</span>, <span class="st">"酉"</span>, <span class="st">"戌"</span>, <span class="st">"亥"</span>), </span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a><span class="co"># データフレームの変数を参照する</span></span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 複数の要素が与えられた時は、与えられた数の出力を行う</span></span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>df_jyunishi <span class="sc">%&gt;%</span> </span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_glue_data</span>(<span class="st">"{2008 + 0:11}年の干支は{eto}です"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2008年の干支は子です
2009年の干支は丑です
2010年の干支は寅です
2011年の干支は卯です
2012年の干支は辰です
2013年の干支は巳です
2014年の干支は午です
2015年の干支は未です
2016年の干支は申です
2017年の干支は酉です
2018年の干支は戌です
2019年の干支は亥です</code></pre>
</div>
</div>
<!-- 表番号 2015年12月25日 14時１分30秒 を例にした -->
<table class="table">
<colgroup>
<col style="width: 16%">
<col style="width: 38%">
<col style="width: 44%">
</colgroup>
<thead>
<tr class="header">
<th>表記</th>
<th>表現</th>
<th>表記の例</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>%a</td>
<td>曜日名の略称</td>
<td>Fri</td>
</tr>
<tr class="even">
<td>%A</td>
<td>完全な曜日名</td>
<td>Friday</td>
</tr>
<tr class="odd">
<td>%b</td>
<td>月名の略称</td>
<td>Dec</td>
</tr>
<tr class="even">
<td>%B</td>
<td>完全な月名</td>
<td>December</td>
</tr>
<tr class="odd">
<td>%c</td>
<td>日付と時間 (“%a %b %e %H:%M:%S %Y”)</td>
<td>Fri Dec 25 14:00:00 2015</td>
</tr>
<tr class="even">
<td>%y</td>
<td>西暦の下２桁</td>
<td>15</td>
</tr>
<tr class="odd">
<td>%Y</td>
<td>西暦</td>
<td>2015</td>
</tr>
<tr class="even">
<td>%m</td>
<td>月</td>
<td>12</td>
</tr>
<tr class="odd">
<td>%d</td>
<td>日(１月の範囲)</td>
<td>25</td>
</tr>
<tr class="even">
<td>%j</td>
<td>日(１年の範囲)</td>
<td>359</td>
</tr>
<tr class="odd">
<td>%H</td>
<td>時間(24時間)</td>
<td>14</td>
</tr>
<tr class="even">
<td>%I</td>
<td>時間(12時間)</td>
<td>02</td>
</tr>
<tr class="odd">
<td>%M</td>
<td>分</td>
<td>01</td>
</tr>
<tr class="even">
<td>%p</td>
<td>午前と午後の区分</td>
<td>PM</td>
</tr>
<tr class="odd">
<td>%S</td>
<td>秒</td>
<td>30</td>
</tr>
<tr class="even">
<td>%w</td>
<td>曜日</td>
<td>5</td>
</tr>
<tr class="odd">
<td>%x</td>
<td>年月日 (“%m/%d/%y”)</td>
<td>12/25/2015</td>
</tr>
<tr class="even">
<td>%X</td>
<td>時刻 (“%H:%M:%S”)</td>
<td>14:01:30</td>
</tr>
</tbody>
</table>
</section>
<section id="桁揃えと丸め込み" class="level4" data-number="4.1.2.10">
<h4 data-number="4.1.2.10" class="anchored" data-anchor-id="桁揃えと丸め込み"><span class="header-section-number">4.1.2.10</span> 桁揃えと丸め込み</h4>
<p>文字数を揃える際には、<code>str_pad()</code>、<code>str_trunc()</code>の2つの関数が役に立つ。これらはそれぞれ、桁揃え、丸め込みを行う関数で、処理を適用する方向を前後、両側あるいは中央のいずれかで指定できる。</p>
<p>例えば、1から20までの数値ですべての値を2桁に揃えるという時には、次のように<em>width</em>で桁数、<em>pad</em>に補間する任意の文字列、“0”を与えた<code>str_pad()</code>を実行する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_pad</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">width =</span> <span class="dv">2</span>, <span class="at">pad =</span> <span class="st">"0"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "01" "02" "03" "04" "05" "06" "07" "08" "09" "10" "11" "12" "13" "14" "15"
[16] "16" "17" "18" "19" "20"</code></pre>
</div>
</div>
<p><code>str_pad()</code>では、補間する文字列を挿入する位置を指定する<em>side</em>引数を除いた引数の値はベクトル化される。すなわち次のように与えられた値と処理の組み合わせを返却する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_pad</span>(<span class="st">"a"</span>, <span class="at">width =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">4</span>), <span class="at">pad =</span> <span class="st">"_"</span>, <span class="at">side =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a____" "a__"   "a___" </code></pre>
</div>
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_pad</span>(<span class="st">"a"</span>, <span class="at">width =</span> <span class="dv">2</span>, <span class="at">pad =</span> <span class="fu">c</span>(<span class="st">"_"</span>, <span class="st">"-"</span>), <span class="at">side =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a_" "a-"</code></pre>
</div>
</div>
<p><code>str_trunc()</code>は<em>string</em>の文字列の長さを<em>width</em>の数値になるよう調節する機能をもつ。既定では”…“が省略時の文字列として使われるが、これは<em>ellipsis</em>によりユーザが変更可能である。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str_trunc</span>(<span class="st">"aaaaaa"</span>, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "aa..."</code></pre>
</div>
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co"># side引数で省略位置の指定を行う</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_trunc</span>(<span class="st">"aaaaaa"</span>, <span class="dv">5</span>, <span class="at">side =</span> <span class="st">"center"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a...a"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ellipsis引数で省略記号を変更する</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str_trunc</span>(<span class="st">"aaaaaa"</span>, <span class="dv">5</span>, <span class="at">ellipsis =</span> <span class="st">"(略)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "aa(略)"</code></pre>
</div>
</div>
</section>
</section>
<section id="forcats" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="forcats"><span class="header-section-number">4.1.3</span> forcatsパッケージ</h3>
<p>順序や項目に意味のある因子型データ (factor, カテゴリデータ)を扱うのに便利なパッケージとして<strong>forcats</strong>を取り上げる。因子型のデータは、3章において<code>data.frame()</code>で文字列を変数に与えた場合に変換される見たように、Rの多くの標準関数、統計処理(<code>glm()</code>などの関数で指定する<em>formula</em>に文字列型データを与えた場合、因子型へ自動変換が行われる)で利用されている。</p>
<p>一方で、どのように因子型として扱われているのか、水準の並びがどうなっているのかを把握せずに処理を進めていくと予想外の結果を招く危険もある。そのためtidyverseのパッケージおよびtibble形式のデータフレームは文字列の因子型への変換を自動的には実行しない仕組みになっている。因子型への変換は、必要に応じて実行すれば良い。</p>
<p><strong>forcats</strong>には、ユーザの使い勝手を向上させた、因子型の操作関数が豊富に含まれている。その使い方を見ていくことにしよう。<strong>forcats</strong>の関数の多くは第一引数に対象とする文字列または因子型のベクトルを指定する。また関数名には<code>fct_</code>という接頭辞が与えられている。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forcats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>まず<strong>forcats</strong>の因子型変換の基本であるが、Rで標準利用可能な因子型への変換を行う関数<code>as.factor()</code>と異なる挙動として、要素が出現した順に水準を与える。これはロケールの設定により結果が異なる可能性のある挙動を制御するのに有効な仕様である。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 標準関数ではロケールの設定を反映した並び替えが行われる</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"C"</span>, <span class="st">"B"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] A C B
Levels: A B C</code></pre>
</div>
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="st">"あ"</span>, <span class="st">"う"</span>, <span class="st">"い"</span>, <span class="st">"お"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] あ う い お
Levels: あ い う お</code></pre>
</div>
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co"># forcats::as_factor() では要素の出現した順番に水準が与えられる</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as_factor</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"C"</span>, <span class="st">"B"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] A C B
Levels: A C B</code></pre>
</div>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sort()を適用して水準を定義する処理</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="st">"あ"</span>, <span class="st">"う"</span>, <span class="st">"い"</span>, <span class="st">"お"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_factor</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] あ い う お
Levels: あ い う お</code></pre>
</div>
</div>
<p>ここからは架空SNSデータを用いて<strong>forcats</strong>パッケージの因子操作関数の解説を行う。データの読み込みは3章で説明した<strong>readr</strong>パッケージを使った方法と同じである。<strong>df_sns</strong>にはnationalityという列があり、この列はSNSへの投稿を行ったユーザの国籍をアルファベット2文字で示した国コードである。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>df_sns <span class="ot">&lt;-</span> </span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"data/sns.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 1000 Columns: 6
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (5): post_id, address, place_name, user_id, nationality
dttm (1): post_time

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>df_sns<span class="sc">$</span>nationality[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="水準のカウント" class="level4" data-number="4.1.3.1">
<h4 data-number="4.1.3.1" class="anchored" data-anchor-id="水準のカウント"><span class="header-section-number">4.1.3.1</span> 水準のカウント</h4>
<p><code>fct_count()</code>は指定したベクトルの頻度をカウントする<code>dplyr::count()</code>関数と類似の機能をもつ関数である。<code>count()</code>との違いは、ベクトルで頻度を数える値を指定すること、集計後の水準が因子型になること、出力結果はデータフレームであるが、変数名が対象のベクトルを指す<em>f</em>と頻度の<em>n</em>からなることである。しかし水準の並びは規定では、頻度ではなく文字の並びとなるので注意が必要である。これは引数<em>sort</em>で<em>TRUE</em>を指定することでデータフレームの並びが頻度の降順になる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>df_count <span class="ot">&lt;-</span> </span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fct_count</span>(df_sns<span class="sc">$</span>nationality)</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ベクトルで与えた変数は因子として扱われる</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>df_count<span class="sc">$</span>f <span class="sc">%&gt;%</span> <span class="fu">levels</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "AU" "CN" "ES" "FR" "GB" "HK" "ID" "IN" "KR" "MY" "PH" "SG" "TH" "TW" "US"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 出力されるデータフレームの並びを頻度の降順にする</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fct_count</span>(df_sns<span class="sc">$</span>nationality, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  f         n
  &lt;fct&gt; &lt;int&gt;
1 TH      166
2 US      152
3 KR      138
4 ID      119
5 CN       84
6 PH       77</code></pre>
</div>
</div>
</section>
<section id="水準の並びかえ" class="level4" data-number="4.1.3.2">
<h4 data-number="4.1.3.2" class="anchored" data-anchor-id="水準の並びかえ"><span class="header-section-number">4.1.3.2</span> 水準の並びかえ</h4>
<p>Rの因子型データへの変換は、ユーザが順位づけを指定しない場合、文字列の並びを優先して並びをつける。これに対して水準の並びを入れ替える関数<code>fct_inorder()</code>と<code>fct_infreq()</code>はそれぞれ、値の出現した順、頻度の多い順に水準の順位づけを行う。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="co"># アルファベットの並びで順序が与えられる</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>df_sns<span class="sc">$</span>nationality <span class="sc">%&gt;%</span> </span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">factor</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">levels</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "AU" "CN" "ES" "FR" "GB" "HK" "ID" "IN" "KR" "MY" "PH" "SG" "TH" "TW" "US"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fct_inorder()... それぞれの水準の並びの違いに注意</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>df_sns<span class="sc">$</span>nationality <span class="sc">%&gt;%</span> </span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>(<span class="at">decreasing =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="co"># アルファベットの降順ソートを行う</span></span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fct_inorder</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">levels</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "US" "TW" "TH" "SG" "PH" "MY" "KR" "IN" "ID" "HK" "GB" "FR" "ES" "CN" "AU"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fct_infreq()... 頻度による順序づけ</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>df_sns<span class="sc">$</span>nationality <span class="sc">%&gt;%</span> </span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fct_infreq</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">levels</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "TH" "US" "KR" "ID" "CN" "PH" "HK" "GB" "MY" "SG" "TW" "AU" "ES" "FR" "IN"</code></pre>
</div>
</div>
<p>既存の水準の並びを変更する関数として、このほか、<code>fct_reorder()</code>や<code>fct_rev()</code>、<code>fct_shift()</code>などがある(表XX)。これらは下記のような作図コード中での利用が効果的になるだろう。</p>
<!-- forcatsの並び替え関数 -->
<table class="table">
<thead>
<tr class="header">
<th>関数</th>
<th>並び替えの方法</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>fct_infreq()</code></td>
<td>頻度で順位をつける</td>
</tr>
<tr class="even">
<td><code>fct_inorder()</code></td>
<td>出現した順番にする</td>
</tr>
<tr class="odd">
<td><code>fct_relevel()</code></td>
<td>文字列による順番の指定</td>
</tr>
<tr class="even">
<td><code>fct_reorder()</code></td>
<td>カウントや最大値など異なる水準値を指定</td>
</tr>
<tr class="odd">
<td><code>fct_rev()</code></td>
<td>順番の反転</td>
</tr>
<tr class="even">
<td><code>fct_shift()</code></td>
<td>指定した数だけずらす</td>
</tr>
<tr class="odd">
<td><code>fct_shuffle()</code></td>
<td>ランダム</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> df_count <span class="sc">%&gt;%</span> </span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(f, n)) <span class="sc">+</span> </span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"default"</span>)</span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 別水準(ここでは頻度)による並び替え</span></span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> df_count <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="fu">fct_reorder</span>(f, n), n)) <span class="sc">+</span> </span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"fct_reorder"</span>)</span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 順位を逆転させる</span></span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> df_count <span class="sc">%&gt;%</span> </span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="fu">fct_rev</span>(<span class="fu">fct_reorder</span>(f, n)), n)) <span class="sc">+</span> </span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"fct_rev"</span>)</span>
<span id="cb201-16"><a href="#cb201-16" aria-hidden="true" tabindex="-1"></a><span class="co"># fct_shiftでは引数nに指定した値分、順位をずらす</span></span>
<span id="cb201-17"><a href="#cb201-17" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> df_count <span class="sc">%&gt;%</span> </span>
<span id="cb201-18"><a href="#cb201-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="fu">fct_shift</span>(<span class="fu">fct_reorder</span>(f, n), <span class="at">n =</span> <span class="dv">3</span>), n)) <span class="sc">+</span> </span>
<span id="cb201-19"><a href="#cb201-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb201-20"><a href="#cb201-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"fct_reorder"</span>)</span>
<span id="cb201-21"><a href="#cb201-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-22"><a href="#cb201-22" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(p1, p2, p3, p4, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ch4-1-forcats" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="ch4_files/figure-html/fig-ch4-1-forcats-1.png" class="img-fluid figure-img" width="864"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">Figure 4.1: forcatsパッケージの水準並び替え</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="水準の変更追加削除" class="level4" data-number="4.1.3.3">
<h4 data-number="4.1.3.3" class="anchored" data-anchor-id="水準の変更追加削除"><span class="header-section-number">4.1.3.3</span> 水準の変更、追加・削除</h4>
<p>因子型のベクトルの水準の値を手動で変更する関数として<code>fct_recode()</code>を紹介する。この関数は、新たに定義したい水準とそれに含まれる要素を文字列で指定する。また、水準から除外する要素がある場合は<em>NULL</em>を指定する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>(x <span class="ot">&lt;-</span> <span class="fu">as_factor</span>(df_sns<span class="sc">$</span>nationality[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] US TH HK ID US
Levels: US TH HK ID</code></pre>
</div>
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co"># US, THの値を「アメリカ」、「タイ」に変換</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="co"># IDをNAとして処理し、水準から除外する</span></span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> </span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fct_recode</span>(</span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">アメリカ</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"US"</span>,</span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">タイ</span><span class="st">`</span>     <span class="ot">=</span> <span class="st">"TH"</span>,</span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">NULL       =</span> <span class="st">"ID"</span></span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] アメリカ タイ     HK       &lt;NA&gt;     アメリカ
Levels: アメリカ タイ HK</code></pre>
</div>
</div>
<p>因子型のベクトルは、個々の要素に与えられた水準が与えられており、次のように一部を参照した場合でも元の水準を含んでいる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 国籍のベクトルを因子型にしたデータの一部を参照</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 水準を引き継ぐ</span></span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>(x[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] US TH
Levels: US TH HK ID</code></pre>
</div>
</div>
<p>使われていない水準を削除するには、標準関数の<code>droplevels()</code>が有効であるが、<code>fct_drop()</code>を使うことで個別の水準を削除することが可能となる。この関数は<code>droplevels()</code>同様、既定では参照されていない水準をすべて除外するが、<em>only</em>引数に対象の水準名を指定することで特定の水準のみを削除することができる。なお、水準が参照されている状態では削除は行われない。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="fu">droplevels</span>(x[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] US TH
Levels: US TH</code></pre>
</div>
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fct_drop</span>(x[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] US TH
Levels: US TH</code></pre>
</div>
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="co"># IDのみを削除 (HKを残す)</span></span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fct_drop</span>(x[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">only =</span> <span class="fu">c</span>(<span class="st">"ID"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] US TH
Levels: US TH HK</code></pre>
</div>
</div>
<p>データに大量の水準がある時、あるいは水準をより大きな水準として処理したい時、<code>fct_collapse()</code>による変換が役立つ。次の処理は、<strong>df_sns</strong>のnationality (国籍)列を大陸ごとにまとめて新たに水準を与える例である。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fct_count</span>(df_sns<span class="sc">$</span>nationality, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  f         n
  &lt;fct&gt; &lt;int&gt;
1 TH      166
2 US      152
3 KR      138
4 ID      119
5 CN       84
6 PH       77</code></pre>
</div>
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fct_collapse</span>(df_sns<span class="sc">$</span>nationality,</span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">Asia    =</span> <span class="fu">c</span>(<span class="st">"CN"</span>, <span class="st">"HK"</span>, <span class="st">"ID"</span>, <span class="st">"IN"</span>, <span class="st">"KR"</span>, </span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"MY"</span>, <span class="st">"PH"</span>, <span class="st">"SG"</span>, <span class="st">"TH"</span>, <span class="st">"TW"</span>),</span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">America =</span> <span class="fu">c</span>(<span class="st">"US"</span>),</span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">Europa  =</span> <span class="fu">c</span>(<span class="st">"ES"</span>, <span class="st">"FR"</span>, <span class="st">"GB"</span>),</span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">Oceania =</span> <span class="fu">c</span>(<span class="st">"AU"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fct_count</span>(<span class="at">sort =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  f           n
  &lt;fct&gt;   &lt;int&gt;
1 Asia      731
2 America   152
3 Europa     73
4 Oceania    23
5 &lt;NA&gt;       21</code></pre>
</div>
</div>
<p><code>fct_lump()</code>は要素の数が多いカテゴリデータに対し、頻度の少ない要素を一つのグループにまとめる処理を実行する。引数<em>n</em>で実行後の要素数を定めるか、<em>prop</em>では全体の頻度から各要素の頻度を割った値を閾値とし、閾値が<em>prop</em>の値未満である時に<em>other_level</em>の値が適用される。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co"># nationalityは15要素からなり、合計で500になる</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(df_sns<span class="sc">$</span>nationality)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 AU  CN  ES  FR  GB  HK  ID  IN  KR  MY  PH  SG  TH  TW  US 
 23  84  20  19  34  58 119   1 138  30  77  29 166  29 152 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co"># nで再グループ化後の要素数を定義する</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>df_sns<span class="sc">$</span>nationality <span class="sc">%&gt;%</span> </span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fct_lump</span>(<span class="at">n =</span> <span class="dv">6</span>, <span class="at">other_level =</span> <span class="st">"その他"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.
    CN     ID     KR     PH     TH     US その他 
    84    119    138     77    166    152    243 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 全体に対するCNの割合は0.128、GBは0.042</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a><span class="co"># propで閾値を設定する... GBはその他のグループに含まれる</span></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>df_sns<span class="sc">$</span>nationality <span class="sc">%&gt;%</span> </span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fct_lump</span>(<span class="at">prop =</span> <span class="fl">0.05</span>, <span class="at">other_level =</span> <span class="st">"その他"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.
    CN     HK     ID     KR     PH     TH     US その他 
    84     58    119    138     77    166    152    185 </code></pre>
</div>
</div>
<p>因子型のベクトルを扱うとき、欠損値は除外して処理されることがある。一方、<code>fct_explicit_na()</code>を用いると欠損値を一時的に文字列へと変換が行われる。欠損値の水準は、水準の最後の値として扱われる。これは例えば<code>table()</code>を使った次の処理で因子型のベクトルの頻度を数えることが可能となる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>nationality <span class="ot">&lt;-</span> </span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>  df_sns<span class="sc">$</span>nationality <span class="sc">%&gt;%</span> </span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_factor</span>()</span>
<span id="cb224-4"><a href="#cb224-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-5"><a href="#cb224-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 欠損値は除外されている</span></span>
<span id="cb224-6"><a href="#cb224-6" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(nationality)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>nationality
 US  TH  HK  ID  AU  SG  CN  MY  PH  KR  GB  ES  FR  TW  IN 
152 166  58 119  23  29  84  30  77 138  34  20  19  29   1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 欠損値 NAは (Missing) という文字列に置換され、結果に含まれる</span></span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>nationality <span class="sc">%&gt;%</span> </span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fct_explicit_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.
       US        TH        HK        ID        AU        SG        CN        MY 
      152       166        58       119        23        29        84        30 
       PH        KR        GB        ES        FR        TW        IN (Missing) 
       77       138        34        20        19        29         1        21 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 欠損値は水準の最後の値に採用される</span></span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="st">"(aa)"</span>, <span class="st">"(zz)"</span>, <span class="cn">NA</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fct_explicit_na</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] (aa)      (zz)      (Missing)
Levels: (aa) (zz) (Missing)</code></pre>
</div>
</div>
<!-- df_count$f %>% fct_anon(prefix = "国籍_"),  fct_unify(), fct_expand() -->
</section>
</section>
</section>
<section id="date-and-time" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="date-and-time"><span class="header-section-number">4.2</span> 日付・時間データの扱い</h2>
<p>日付や時間はデータが記録された時点の値が記述されることが多く、データを比較する際の一つの基準として用いられる。例えば定点観測によって得られるログデータでは、時間の推移状態から異常を検知したり、不安定な変動の発生を記録する。日付・時間データは、今日の1日前が昨日、2日後は明後日というように、数値的な算術演算が可能である。一方で日付・時間には表記方法やタイムゾーンの違いを考慮する必要があり、また丸め込みといった処理によってデータが異なるものに変化することがあるため、その扱いには気をつけなければいけない。ここではRにおける日付・時間データの基礎的な操作方法とともにパッケージを使った日付・時間データの処理と応用的な処理の例を見ていくことにする。</p>
<section id="rにおける日付時間データ" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="rにおける日付時間データ"><span class="header-section-number">4.2.1</span> Rにおける日付・時間データ</h3>
<p>日付・時間を表す形式(2018年1月1日を示す2018-01-01など)にはさまざまなものがあるが、Rでは、こうした日付を示す文字列を定義しても文字型のデータとみなされる。これを日付として扱うには、<code>as.*</code>関数群の中にある<code>as.Date</code>関数を利用する必要がある。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="st">"2018-02-05"</span></span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 日付を表す文字を変換する</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as.Date</span>(x) <span class="sc">%&gt;%</span> <span class="fu">class</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Date"</code></pre>
</div>
</div>
<p>Rでは日付や時間に関するデータの取り扱いのために専用のクラスを用意しており、日付を扱うオブジェクトとしてDate、日付・時間のオブジェクトを表すPOSIXlt並びにPOSIXctと呼ばれるクラスが該当する。これらのクラスは、Dateが日付だけを扱うのに対してPOSIXltおよびPOSIXctは日付と時間(秒単位まで)を扱うという点で異なっている。日付や時間を示すこれらのクラスは、日数の集計や現在から30分後の時間といった演算処理を可能にするために協定世界時 UTC (Universal Time Coordinated)と呼ばれる基準点を利用している。UTCでは1970年1月1日の0時0分を基準とし、年月日や時間に関する計算はこれを0とみなして実行される。次に示す簡単な例でこの概念を確認してみよう。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 協定世界時での1970年1月1日が数値的に0として扱われることを確認</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(<span class="fu">as.Date</span>(<span class="st">"1970-01-01"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tz引数に協定世界時 UTCを与えた際の1970年1月1日0時0分を数値化</span></span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(<span class="fu">as.POSIXlt</span>(<span class="st">"1970-01-01 00:00:00"</span>, <span class="at">tz =</span> <span class="st">"UTC"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 日付オブジェクトを生成するas.Date()関数では、1970年1月1日から一日進むごとに数値が1加えられる</span></span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as.Date</span>(<span class="st">"1970-01-02"</span>) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 時間オブジェクトを生成するas.POSIXlt()関数では1秒ごとに1追加される</span></span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(<span class="fu">as.POSIXlt</span>(<span class="st">"1970-01-01 00:00:01"</span>, <span class="at">tz =</span> <span class="st">"UTC"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 本書執筆時の日付・時間とその数値変換した値の出力とその数値的表現</span></span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.Date</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(<span class="fu">Sys.Date</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 19114</code></pre>
</div>
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.time</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02 16:57:13 JST"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(<span class="fu">Sys.time</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1651478234</code></pre>
</div>
</div>
<p>日付・時間を扱うオブジェクトでは、算術演算子を用いた演算処理が可能である。また同一クラスのオブジェクトであれば、オブジェクト間で算術演算が利用できる。例えば、<code>Sys.Date()</code>により求めた「今日」の日付から1を引くと「昨日」の日付が出力される。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dateオブジェクトでは1日を単位1として演算処理を行う</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">Sys.Date</span>()</span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 昨日の日付を求める</span></span>
<span id="cb250-4"><a href="#cb250-4" aria-hidden="true" tabindex="-1"></a>x <span class="sc">-</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-01"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 現在の日付から10日後の日付を返す</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>x <span class="sc">+</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-12"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="co"># POSIXctオブジェクトでは1秒を1単位として扱う</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>x <span class="sc">-</span> <span class="dv">3</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02 13:57:13 JST"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co"># クラスが異なるために警告が表示される</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.time</span>() <span class="sc">-</span> <span class="fu">Sys.Date</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Incompatible methods ("-.POSIXt", "-.Date") for "-"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02 11:38:39 JST"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 指定されていない日付・時間は丸め込み処理が行われる</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as.POSIXct</span>(<span class="st">"1970-01-01"</span>) <span class="sc">-</span> <span class="fu">as.POSIXct</span>(<span class="st">"2015-12-25 21:00:00"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of -16794.88 days</code></pre>
</div>
</div>
</section>
<section id="lubridate" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="lubridate"><span class="header-section-number">4.2.2</span> lubridateパッケージ</h3>
<p>日付・時間データの処理に特化したパッケージはいくつかあるが、本書では<strong>lubridate</strong>を取り上げる。このパッケージはGarrett GrolemundとHadley Wickhamによって開発されたもので、開発思想として利用者が日付・時間のデータや時間帯の処理を直感的に操作できるようになることを目的としている。またtidyverse群に含まれるパッケージであり、データ操作の<strong>dplyr</strong>やパイプ処理と相性が良い。また<strong>lubridate</strong>の関数が返す値の多くはPOSIXctクラスをもっているため、従来の日付・時間クラスとの演算が可能となっている。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'lubridate'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    date, intersect, setdiff, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 直感的に理解しやすい関数を豊富に備えている</span></span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a><span class="fu">today</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="fu">now</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02 16:57:13 JST"</code></pre>
</div>
</div>
<section id="日付時間の生成" class="level4" data-number="4.2.2.1">
<h4 data-number="4.2.2.1" class="anchored" data-anchor-id="日付時間の生成"><span class="header-section-number">4.2.2.1</span> 日付・時間の生成</h4>
<p><code>ymd()</code>や<code>ymd_hms()</code>といった関数は利用者が入力した日付・時間を示す文字列を整形して出力する。これらの関数は日付と時間を構成する文字列、年であればyear、月はmonth、日はdayのように、対象の文字列が示す日付・時間の表記形式に対応して読み込みを実行する。<code>dmy()</code>のように構成要素の順番を入れ替えることであらゆる日付・時間の表記に対応することができる。対象がベクトルで複数の要素を含んでいる場合でも、日付・時間の構成要素が共通していれば出力が行われる。また日付・時間以外の文字列が含まれている際には日付・時間を示す文字のみ抽出し、暦に用いられる文字列の場合には適当な置換を行う仕様となっている。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 年月日形式の文字列を日付として扱う</span></span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">"20151225"</span>, <span class="at">tz =</span> <span class="st">"Asia/Tokyo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2015-12-25 JST"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 年月日という表記形式に対応する</span></span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="fu">c</span>(<span class="st">"20151225"</span>, <span class="st">"2017-02-24"</span>, <span class="st">"2001年8月31日"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2015-12-25" "2017-02-24" "2001-08-31"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 表記形式の異なる要素では読み込みに失敗する</span></span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd_hms</span>(<span class="fu">c</span>(<span class="st">"20151225 12:30:40"</span>, <span class="st">"2017-02-24 12:30:40"</span>, <span class="st">"August 31, 2001"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 1 failed to parse.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2015-12-25 12:30:40 UTC" "2017-02-24 12:30:40 UTC"
[3] NA                       </code></pre>
</div>
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 日付・時間の要素のみを対象にする</span></span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="fu">c</span>(<span class="st">"今日は2017年2月25日です。"</span>,</span>
<span id="cb275-3"><a href="#cb275-3" aria-hidden="true" tabindex="-1"></a>               <span class="st">"明日は2017年2月26日です"</span>,</span>
<span id="cb275-4"><a href="#cb275-4" aria-hidden="true" tabindex="-1"></a>               <span class="st">"20170227"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2017-02-25" "2017-02-26" "2017-02-27"</code></pre>
</div>
</div>
<p>他に、日付・時間の個々の構成要素を引数で指定して実行する<code>make_date()</code>、<code>make_datetime()</code>を用いて日付・時間オブジェクトを生成することができる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_date</span>(<span class="at">year =</span> <span class="dv">1970</span>, <span class="at">month =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">day =</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1970-01-05" "1970-02-04" "1970-03-03"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 指定を省略した要素には0あるいは1が与えられる</span></span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make_datetime</span>(<span class="dv">1970</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">hour =</span> <span class="dv">3</span>, <span class="at">sec =</span> <span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1970-01-01 03:00:30 UTC"</code></pre>
</div>
</div>
</section>
<section id="日付時間の演算と更新" class="level4" data-number="4.2.2.2">
<h4 data-number="4.2.2.2" class="anchored" data-anchor-id="日付時間の演算と更新"><span class="header-section-number">4.2.2.2</span> 日付・時間の演算と更新</h4>
<p>日付・時間の算術演算は<code>+</code>や<code>-</code>演算子を利用して行うことが可能である。数値を与えた場合、算術演算は日付・時間オブジェクトの最小単位に対して実行される。そこで、演算の対象とする単位を<strong>lubridate</strong>の<code>quick_periods()</code>を用いて実行するのが効率的である。例えば2月26日から同日の一ヶ月後となる3月26日に変更したいとき、月の日数を考慮して処理しなければいけなかったものが、<code>months()</code>を使って以下のように処理できる。<code>quick_periods()</code>の関数群の名前は日付・時間の単位を複数形で表現したものとなる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 算術演算子を使った処理</span></span>
<span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">"20160226"</span>) <span class="sc">-</span> <span class="dv">7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2016-02-19"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd_hms</span>(<span class="st">"20160226 04:55:21"</span>) <span class="sc">+</span> <span class="dv">20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2016-02-26 04:55:41 UTC"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb285"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3月26日を求める</span></span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">"20160226"</span>) <span class="sc">+</span> <span class="dv">29</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2016-03-26"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb287"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">"20160226"</span>) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2016-03-26"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb289"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">"19891127"</span>) <span class="sc">+</span> <span class="fu">years</span>(<span class="dv">28</span>) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">3</span>) <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2018-01-28"</code></pre>
</div>
</div>
<p>ただし<code>+</code>や<code>-</code>演算子を使った処理では、末日が現実に存在しない値を得る場合に処理が失敗する。具体的には11月の末日30日であるが2月は28日で終わる(閏年の場合は29日まである)。そのため、次のように11月30日から1ヶ月ごとの末日を得ようとすると2月の値は演算に失敗してしまう。<strong>lubridate</strong>が提供する<code>%m+%</code>演算子は、この問題を考慮し、演算を実行する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb291"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1989年11月から1ヶ月刻みで増やしていく</span></span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">"19891130"</span>) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "1989-12-30" "1990-01-30" NA           "1990-03-30" "1990-04-30"
 [6] "1990-05-30" "1990-06-30" "1990-07-30" "1990-08-30" "1990-09-30"
[11] "1990-10-30" "1990-11-30"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb293"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">"19891130"</span>) <span class="sc">%m+%</span> <span class="fu">months</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "1989-12-30" "1990-01-30" "1990-02-28" "1990-03-30" "1990-04-30"
 [6] "1990-05-30" "1990-06-30" "1990-07-30" "1990-08-30" "1990-09-30"
[11] "1990-10-30" "1990-11-30"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">"19891130"</span>) <span class="sc">%m+%</span> <span class="fu">years</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "1990-11-30" "1991-11-30" "1992-11-30" "1993-11-30" "1994-11-30"
 [6] "1995-11-30" "1996-11-30" "1997-11-30" "1998-11-30" "1999-11-30"
[11] "2000-11-30" "2001-11-30"</code></pre>
</div>
</div>
<p>関数<code>update()</code>を使い、日付・時間への修正を加えることもできる。この関数は引数に日付・時間の構成要素名を与えて実行する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb297"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a>(x <span class="ot">&lt;-</span> <span class="fu">now</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02 16:57:13 JST"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb299"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="fu">update</span>(x, <span class="at">year =</span> <span class="dv">1989</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1989-05-02 16:57:13 JST"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb301"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="fu">update</span>(x, <span class="at">hour =</span> <span class="dv">11</span>, <span class="at">minute =</span> <span class="dv">30</span>, <span class="at">second =</span> <span class="dv">00</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02 11:30:00 JST"</code></pre>
</div>
</div>
</section>
<section id="期間" class="level4" data-number="4.2.2.3">
<h4 data-number="4.2.2.3" class="anchored" data-anchor-id="期間"><span class="header-section-number">4.2.2.3</span> 期間</h4>
<p>日付・時間において2つの時刻を扱う場合には期間という概念が発生する。そのため<strong>lubridate</strong>パッケージでは、日付・時間に関する特殊なオブジェクトとして期間に関する3つのクラスを提供する。これらは<code>interval()</code>、<code>duration()</code>、<code>period()</code>という関数名が示す通り、それぞれ、時刻Aから時刻Bまでの間を示す期間、長さとして与えられる時間の間隔、時間の単位で構成される長さを示すものとなっている。この中で特に<code>duration()</code>は、継続中の時間を示す期間の概念である。</p>
<p>2つの任意の時刻における間の時間を求める際には<code>interval()</code>が関数が役に立つ。また関数の代わりに演算子<code>%--%</code>を利用しても良い。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb303"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1970年1月1にから今日までのIntervalクラスオブジェクトを作る</span></span>
<span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a>time_int <span class="ot">&lt;-</span> </span>
<span id="cb303-3"><a href="#cb303-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">interval</span>(<span class="fu">ISOdate</span>(<span class="st">"1970"</span>, <span class="st">"01"</span>, <span class="st">"01"</span>), <span class="fu">today</span>(), <span class="at">tzone =</span> <span class="st">"Asia/Tokyo"</span>)</span>
<span id="cb303-4"><a href="#cb303-4" aria-hidden="true" tabindex="-1"></a>time_int</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1970-01-01 21:00:00 JST--2022-05-02 09:00:00 JST</code></pre>
</div>
<div class="sourceCode cell-code" id="cb305"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="fu">interval</span>(<span class="fu">as.Date</span>(<span class="st">"2016-01-01"</span>), <span class="fu">today</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2016-01-01 UTC--2022-05-02 UTC</code></pre>
</div>
<div class="sourceCode cell-code" id="cb307"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="co"># %--%演算子によるIntervalクラスオブジェクトの生成</span></span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ISOdate</span>(<span class="st">"2016"</span>, <span class="st">"01"</span>, <span class="st">"01"</span>) <span class="sc">%--%</span> <span class="fu">today</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2016-01-01 12:00:00 GMT--2022-05-02 GMT</code></pre>
</div>
</div>
<p>Intervalに関しては、Intervalオブジェクトであるかを検証する<code>is.interval()</code>をはじめとし、期間の始点と終点を返す<code>int_start()</code>および<code>int_end()</code>、2つの期間の重なりを検知する<code>int_overlaps()</code>などが適用できる。また<code>int_shift()</code>や<code>int_start()</code>、<code>int_end()</code>を使って既存の期間の値を変更することが可能である。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb309"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Intervalオブジェクトに対する検証</span></span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a><span class="fu">is.interval</span>(time_int)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb311"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 期間の始点と終点を返す</span></span>
<span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a><span class="fu">int_start</span>(time_int)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1970-01-01 21:00:00 JST"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb313"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a><span class="fu">int_end</span>(time_int)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02 09:00:00 JST"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb315"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 期間を反転させる</span></span>
<span id="cb315-2"><a href="#cb315-2" aria-hidden="true" tabindex="-1"></a><span class="fu">int_flip</span>(time_int)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2022-05-02 09:00:00 JST--1970-01-01 21:00:00 JST</code></pre>
</div>
<div class="sourceCode cell-code" id="cb317"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 期間の長さを秒単位で表示する(1日の長さを示す)</span></span>
<span id="cb317-2"><a href="#cb317-2" aria-hidden="true" tabindex="-1"></a><span class="fu">int_length</span>(<span class="fu">interval</span>(<span class="fu">today</span>() <span class="sc">-</span> <span class="dv">1</span>, <span class="fu">today</span>(), <span class="at">tzone =</span> <span class="st">"Asia/Tokyo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 86400</code></pre>
</div>
<div class="sourceCode cell-code" id="cb319"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 期間中の時間を標準化させる</span></span>
<span id="cb319-2"><a href="#cb319-2" aria-hidden="true" tabindex="-1"></a><span class="fu">int_standardize</span>(time_int)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1970-01-01 21:00:00 JST--2022-05-02 09:00:00 JST</code></pre>
</div>
<div class="sourceCode cell-code" id="cb321"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 期間をずらす</span></span>
<span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a><span class="fu">int_shift</span>(time_int, <span class="fu">duration</span>(<span class="at">days =</span> <span class="dv">30</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1970-01-31 21:00:00 JST--2022-06-01 09:00:00 JST</code></pre>
</div>
<div class="sourceCode cell-code" id="cb323"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a><span class="fu">int_shift</span>(time_int, <span class="fu">duration</span>(<span class="at">days =</span> <span class="sc">-</span><span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1969-12-27 21:00:00 JST--2022-04-27 09:00:00 JST</code></pre>
</div>
</div>
<p><code>int_aligns()</code>および<code>int_overlaps()</code>は2つのオブジェクトを比較し、期間の重なりを検知して論理値を返す。<code>int_aligns()</code>は期間のうち、始点や終点のいずれかが共通である時に<em>TRUE</em>を返す。また<code>int_overlaps()</code>は2つのオブジェクトの期間が重複している場合に<em>TRUE</em>となる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb325"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="fu">int_aligns</span>(<span class="fu">interval</span>(<span class="fu">ISOdate</span>(<span class="st">"1970"</span>, <span class="st">"01"</span>, <span class="st">"01"</span>), <span class="fu">ymd</span>(<span class="st">"2012-04-01"</span>), <span class="at">tzone =</span> <span class="st">"Asia/Tokyo"</span>), </span>
<span id="cb325-2"><a href="#cb325-2" aria-hidden="true" tabindex="-1"></a>           <span class="fu">interval</span>(<span class="fu">ISOdate</span>(<span class="st">"1989"</span>, <span class="st">"11"</span>, <span class="st">"17"</span>), <span class="fu">today</span>(), <span class="at">tzone =</span> <span class="st">"Asia/Tokyo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb327"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2つの期間は終点が同じであるため、返り値がTRUEとなる</span></span>
<span id="cb327-2"><a href="#cb327-2" aria-hidden="true" tabindex="-1"></a><span class="fu">int_aligns</span>(<span class="fu">interval</span>(<span class="fu">ISOdate</span>(<span class="st">"1970"</span>, <span class="st">"01"</span>, <span class="st">"01"</span>), <span class="fu">today</span>(), <span class="at">tzone =</span> <span class="st">"Asia/Tokyo"</span>), </span>
<span id="cb327-3"><a href="#cb327-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">interval</span>(<span class="fu">ISOdate</span>(<span class="st">"1989"</span>, <span class="st">"11"</span>, <span class="st">"17"</span>), <span class="fu">today</span>(), <span class="at">tzone =</span> <span class="st">"Asia/Tokyo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb329"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a><span class="fu">int_overlaps</span>(<span class="fu">interval</span>(<span class="fu">ISOdate</span>(<span class="st">"1970"</span>, <span class="st">"01"</span>, <span class="st">"01"</span>), <span class="fu">ymd</span>(<span class="st">"2012-04-01"</span>), <span class="at">tzone =</span> <span class="st">"Asia/Tokyo"</span>), </span>
<span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a>           <span class="fu">interval</span>(<span class="fu">ISOdate</span>(<span class="st">"1989"</span>, <span class="st">"11"</span>, <span class="st">"17"</span>), <span class="fu">today</span>(), <span class="at">tzone =</span> <span class="st">"Asia/Tokyo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb331"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="fu">interval</span>(<span class="fu">as.Date</span>(<span class="st">"2016-01-01"</span>), <span class="fu">today</span>()) <span class="sc">/</span> <span class="fu">ddays</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1156.5</code></pre>
</div>
</div>
<p>ある日付・時間のオブジェクトが、2期間の間に含まれるかを判定する演算子が<code>%within%</code>として提供されている。この演算子は、左辺に対象の日付・時間オブジェクト、右辺にIntervalオブジェクトを指定して実行する。返り値は論理値である。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb333"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 5月1日から8日までの日付オブジェクトを生成</span></span>
<span id="cb333-2"><a href="#cb333-2" aria-hidden="true" tabindex="-1"></a>(x <span class="ot">&lt;-</span> </span>
<span id="cb333-3"><a href="#cb333-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_date</span>(<span class="dv">2018</span>, <span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2018-05-01" "2018-05-02" "2018-05-03" "2018-05-04" "2018-05-05"
[6] "2018-05-06" "2018-05-07" "2018-05-08"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb335"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a>renkyu <span class="ot">&lt;-</span> </span>
<span id="cb335-2"><a href="#cb335-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">interval</span>(<span class="fu">ymd</span>(<span class="st">"2018-05-03"</span>), <span class="fu">ymd</span>(<span class="st">"2018-05-06"</span>))</span>
<span id="cb335-3"><a href="#cb335-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-4"><a href="#cb335-4" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%within%</span> renkyu</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE FALSE  TRUE  TRUE  TRUE  TRUE FALSE FALSE</code></pre>
</div>
</div>
<p><code>interval()</code>が生成するIntervalに対し、<code>duration()</code>や<code>dseconds()</code>などの関数で実行される返り値はDurationオブジェクトとなる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb337"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a>x.duration <span class="ot">&lt;-</span> <span class="fu">duration</span>(<span class="at">day =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">units =</span> <span class="st">"day"</span>)</span>
<span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(x.duration)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Duration"
attr(,"package")
[1] "lubridate"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb339"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is.duration</span>(x.duration)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb341"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a><span class="fu">duration</span>(<span class="at">second =</span> <span class="dv">90</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "90s (~1.5 minutes)"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb343"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 文字列からも作成できる</span></span>
<span id="cb343-2"><a href="#cb343-2" aria-hidden="true" tabindex="-1"></a><span class="fu">duration</span>(<span class="st">"31 days"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2678400s (~4.43 weeks)"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb345"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1年の秒表記</span></span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dyears</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "31557600s (~1 years)"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb347"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1週間と7日間は同じ期間である</span></span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dweeks</span>(<span class="dv">1</span>) <span class="sc">-</span> <span class="fu">ddays</span>(<span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0s"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb349"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1~3時間の期間を秒数で返す</span></span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">*</span> <span class="fu">dhours</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "3600s (~1 hours)"  "7200s (~2 hours)"  "10800s (~3 hours)"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb351"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1日の秒数を返す</span></span>
<span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a><span class="fu">int_length</span>(<span class="fu">interval</span>(<span class="fu">today</span>() <span class="sc">-</span> <span class="dv">1</span>, <span class="fu">today</span>(), <span class="at">tzone =</span> <span class="st">"Asia/Tokyo"</span>)) <span class="sc">%&gt;%</span> <span class="fu">dseconds</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "86400s (~1 days)"</code></pre>
</div>
</div>
<p>最後の時間の期間を示すオブジェクトは<code>period()</code>によって作成されるPeriodクラスである。<code>period()</code>では引数に<em>units</em>があり、時間の単位を指定する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb353"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="fu">period</span>(<span class="dv">1</span>, <span class="st">"days"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1d 0H 0M 0S"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb355"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="fu">today</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb357"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="fu">today</span>() <span class="sc">-</span> <span class="fu">period</span>(<span class="at">day =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-04-22"</code></pre>
</div>
</div>
<p>なおこれまでに見てきた3つの期間に関係するクラスは、<code>as.*()</code>による関数で相互にクラスの変更が可能である。</p>
</section>
<section id="時間帯の指定" class="level4" data-number="4.2.2.4">
<h4 data-number="4.2.2.4" class="anchored" data-anchor-id="時間帯の指定"><span class="header-section-number">4.2.2.4</span> 時間帯の指定</h4>
<p><strong>lubridate</strong>では既存の関数による時間帯やロケールの指定に対応した関数が備わっている。時間帯が指定可能な関数では引数<em>tz</em>あるいは<em>tzone</em>により指定を行う。引数<em>tz</em>あるいは<em>tzone</em>で指定することが多い。例えば同一時刻について異なる時間帯での時刻を確認するには<code>with_tz()</code>に対象のオブジェクトと引数<em>tzone</em>に時間帯を指定して実行する。利用可能な時間帯の名称については<code>OlsonNames()</code>により確認できる。</p>
<!-- olson_time_zones()は廃止-->
<div class="cell">
<div class="sourceCode cell-code" id="cb359"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 現在の時刻を出力する。時間帯にはJST 日本標準時が使われている</span></span>
<span id="cb359-2"><a href="#cb359-2" aria-hidden="true" tabindex="-1"></a>(x <span class="ot">&lt;-</span> <span class="fu">now</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02 16:57:14 JST"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb361"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with_tz()では、引数tzone に与えた時間帯での時間を返す</span></span>
<span id="cb361-2"><a href="#cb361-2" aria-hidden="true" tabindex="-1"></a><span class="fu">with_tz</span>(x, <span class="at">tzone =</span> <span class="st">"UTC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02 07:57:14 UTC"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb363"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with_tz</span>(x, <span class="at">tzone =</span> <span class="st">"America/Puerto_Rico"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-05-02 03:57:14 AST"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb365"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 引数tzで時間帯を指定する</span></span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">"2015-October-17"</span>, <span class="at">tz =</span> <span class="st">"Asia/Tokyo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2015-10-17 JST"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb367"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ymd</span>(<span class="st">"2015年10月10日"</span>, <span class="at">tz =</span> <span class="st">"Asia/Tokyo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2015-10-10 JST"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb369"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="dv">25122015</span>, <span class="st">"27-11-2015"</span>, <span class="st">"2日1月2000年"</span>) <span class="sc">%&gt;%</span> <span class="fu">dmy</span>(<span class="at">tz =</span> <span class="st">"Asia/Tokyo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2015-12-25 JST" "2015-11-27 JST" "2000-01-02 JST"</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="まとめ" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="まとめ"><span class="header-section-number">4.3</span> まとめ</h2>
<ul>
<li>因子型を含めた文字、日付・時間のデータは、数値とは扱いが異なり、tidyverseでは専用の処理パッケージ、<strong>stringr</strong>、<strong>forcats</strong>、<strong>lubridate</strong>が用意されている。</li>
<li><strong>stringr</strong>はICUの正規表現ライブラリを実装しており、柔軟なパターンマッチを可能にする</li>
<li><strong>forcats</strong>は因子型データの処理に特化し、Rの標準の因子データの扱いの使い勝手を向上させる。</li>
<li><strong>lubridate</strong>には日付・時間のデータ処理を容易にする、日付・時間の生成関数<code>make_date()</code>や<code>ymd()</code>、期間を扱う<code>interval()</code>などの関数、日付・時間の演算のための<code>%m+%</code>、<code>%interval%</code>演算子を提供する。</li>
</ul>


</section>

</main> <!-- /main -->
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./ch3.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">表形式のデータソースからのデータ取得</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./ch5.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">効率的なデータ操作</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>